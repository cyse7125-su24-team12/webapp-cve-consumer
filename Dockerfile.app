# Final stage
FROM alpine:3.15.11
# Install necessary packages with pinned versions
# You'll need to find the exact versions available for your Alpine version.
RUN apk --no-cache add \
    postgresql-client=13.5-r0 \
    openjdk11-jre=11.0.11_p9-r0 \
    bash=5.1.16-r0 \
    wget=1.21.2-r1

# Download and setup Kafka command-line tools (adjust version as necessary)
RUN wget --progress=dot:giga https://archive.apache.org/dist/kafka/3.4.0/kafka_2.13-3.4.0.tgz -O /tmp/kafka.tgz \
    && tar -xzf /tmp/kafka.tgz -C /opt \
    && rm /tmp/kafka.tgz

# Configure environment variables
ENV PATH="/opt/kafka_2.13-3.4.0/bin:${PATH}"
# Uncomment if Java is needed in the runtime environment
# ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk
ENV CLASSPATH="/opt/kafka_2.13-3.4.0/libs/*"

WORKDIR /root/

# Copy the compiled binary from the builder stage
COPY --from=builder /app/main .

# Copy db_check.sh script and make it executable
COPY ./scripts/db_check.sh /usr/local/bin/db_check.sh
RUN chmod +x /usr/local/bin/db_check.sh

CMD ["./main"]
